!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e:"function"==typeof define&&define.amd?define("JZZ.gui.Player",["JZZ","JZZ.midi.SMF"],e):e(JZZ)}(0,function(l){if(l.gui||(l.gui={}),!l.gui.Player){var n={on:t,off:t,disable:t,div:{}};u.prototype.on=function(){this.div.style.backgroundColor="#ddd",this.div.style.borderColor="#ccc",this.div.firstChild.style.fill="#000"},u.prototype.off=function(){this.div.style.backgroundColor="#aaa",this.div.style.borderColor="#ccc",this.div.firstChild.style.fill="#000"},u.prototype.disable=function(){this.div.style.backgroundColor="#888",this.div.style.borderColor="#aaa",this.div.firstChild.style.fill="#555"};var a='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',p='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',r='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 6h12v12H6z"/></svg>',h='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>',d='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>',c='<svg fill="#555" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M10 4H2v16h20V6H12l-2-2z"/></svg>',y=0;v.prototype.disable=function(){this.playBtn.disable(),this.pauseBtn.disable(),this.stopBtn.disable(),this.loopBtn.disable(),this.moreBtn.disable(),this.openBtn.off(),this.rail.style.borderColor="#aaa",this.rail.style.backgroundColor="#888",this.caret.style.borderColor="#aaa",this.caret.style.backgroundColor="#888"},v.prototype.enable=function(){this.playBtn.off(),this.pauseBtn.off(),this.stopBtn.off(),this.loopBtn.off(),this._out||this.moreBtn.off(),this.rail.style.borderColor="#ccc",this.caret.style.backgroundColor="#aaa",this.caret.style.borderColor="#ccc"},v.prototype.load=function(t){var e=this;this._player=t.player(),this._out&&this._player.connect(this._out),this._player.onEnd=function(){e._onEnd()},this.enable()},v.prototype.onEnd=function(){},v.prototype._onEnd=function(){this.onEnd(),this._loop&&-1!=this._loop&&this._loop--,this._loop?1==this._loop?(this._loop=0,this.loopBtn.off(),this.loopBtn.div.title="loop"):this.loopBtn.div.title="loop: "+(-1==this._loop?"∞":this._loop):(this._moving&&clearInterval(this._moving),this._move(),this._playing=!1,this.playBtn.off())},v.prototype._move=function(){var t=Math.round(this._player.position()*this.rlen/this._player.duration())-5;this.caret.style.left=t+"px"},v.prototype.play=function(){if(this._player){var t=this;if(this.playBtn.on(),this.pauseBtn.off(),this._out){if(this._playing)return;this._waiting=!1,this._player.connect(this._out),this._paused?this._player.resume():this._player.play(),this._moving=setInterval(function(){t._move()},100),this._playing=!0,this._paused=!1}else this._waiting||(this._waiting=!0,l().openMidiOut(void 0,/MIDI Through/i).and(function(){t._out=this,t._outname=this.name(),t.play()}))}},v.prototype.stop=function(){this._player&&(this._player.stop(),this._moving&&clearInterval(this._moving),this._playing=!1,this._paused=!1,this.playBtn.off(),this.pauseBtn.off(),this._move())},v.prototype.pause=function(t){if(this._player){var e=this;this._paused?(void 0===t||t)&&(this._out?(this._player.resume(),this._moving=setInterval(function(){e._move()},100),this._playing=!0,this._paused=!1,this.playBtn.on(),this.pauseBtn.off()):this.play()):this._playing&&(void 0!==t&&t||(this._player.pause(),this._moving&&clearInterval(this._moving),this._playing=!1,this._paused=!0,this.playBtn.off(),this.pauseBtn.on()))}},v.prototype.loop=function(t){this._player&&(void 0===t&&(t=!this._loop),t==parseInt(t)&&0<t?this._loop=t:this._loop=t?-1:0,1==this._loop&&(this._loop=0),this._player.loop(this._loop),this._loop?(this.loopBtn.on(),this.loopBtn.div.title="loop: "+(-1==this._loop?"∞":this._loop)):(this.loopBtn.off(),this.loopBtn.div.title="loop"))},v.prototype.close=function(t){this.stop(),this.gui.parentNode.removeChild(this.gui)},v.prototype.readFile=function(t){var n=this,e=new FileReader;e.onload=function(t){for(var e="",i=new Uint8Array(t.target.result),o=0;o<i.length;o++)e+=String.fromCharCode(i[o]);try{var s=new l.MIDI.SMF(e);n.stop(),n.load(s),n.play()}catch(t){}},e.readAsArrayBuffer(t)},v.prototype._closeselect=function(){this.moreBtn.off(),this.select.style.display="none",this._more=!1},v.prototype.settings=function(){if(this._player&&!this._more&&!this._connector){var i=this;this._more=!0,this.moreBtn.on(),this.select.style.display="inline-block",l().refresh().and(function(){var t,e=this.info().outputs;for(t=0;t<i.select.options.length;t++)i.select.remove(t);for(t=0;t<e.length;t++)i.select[t]=new Option(e[t].name,e[t].name,e[t].name==i._outname,e[t].name==i._outname);i.select.size=e.length<2?2:e.length,i.select.focus()})}},v.prototype._selectMidi=function(){var t=this;l().openMidiOut(this._newname).or(function(){t._newname=void 0,t._closeselect()}).and(function(){t._connector||(t._outname=t._newname,t._player&&(t._player.sndOff(),t._player.disconnect(t._out)),t._out=this,t._player&&t._player.connect(t._out),t._newname=void 0,t._closeselect())})},v.prototype._selected=function(){var t=this;this._newname=this.select.options[this.select.selectedIndex].value,this._newname==this._outname?(this._newname=void 0,t._closeselect()):setTimeout(function(){t._selectMidi()},0)},v.prototype._keydown=function(t){13!=t.keyCode&&32!=t.keyCode||this._selected()},v.prototype.duration=function(){return this._player?this._player.duration():0},v.prototype.position=function(){return this._player?this._player.position():0},v.prototype.jump=function(t){this._player&&(this._player.jump(t),this._move(),this._playing||(t?(this._paused=!0,this.playBtn.off(),this.pauseBtn.on()):(this._paused=!1,this.playBtn.off(),this.pauseBtn.off())))},v.prototype._mousedown=function(t){e(t)&&this._player&&(this.caret.style.backgroundColor="#ddd",this._wasPlaying=this._playing,this._player.pause(),this._caretX=t.clientX,this._caretPos=parseInt(this.caret.style.left)+5)},v.prototype._startmove=function(t){e(t)&&(this._startX=parseInt(this.gui.style.left),this._startY=parseInt(this.gui.style.top),this._clickX=t.clientX,this._clickY=t.clientY)},v.prototype._mouseup=function(t){this._player&&void 0!==this._caretX&&(this._wasPlaying&&(this._wasPlaying=void 0,this._player.resume()),this.caret.style.backgroundColor="#aaa",this._caretX=void 0),void 0!==this._startX&&(this._startX=void 0,this._startY=void 0,this._clickX=void 0,this._clickY=void 0)},v.prototype._mousemove=function(t){if(this._player&&void 0!==this._caretX){t.preventDefault();var e=this._caretPos+t.clientX-this._caretX;e<0&&(e=0),e>this.rlen&&(e=this.rlen),this.jump(this.duration()*e*1/this.rlen)}else void 0!==this._startX&&(t.preventDefault(),this.gui.style.left=this._startX-this._clickX+t.clientX+"px",this.gui.style.top=this._startY-this._clickY+t.clientY+"px")},v.prototype.connect=function(t){this._connector||(this._connector=new l.Widget,this._player&&(this._playing&&this._player.sndOff(),this._player.disconnect(),this._player.connect(this._connector)),this.moreBtn.disable(),this._out=this._connector),this._connector.connect(t)},v.prototype.disconnect=function(t){this._connector&&(this._player&&this._playing&&this._player.sndOff(),this._connector.disconnect(t),this._connector.connected()||(this.moreBtn.off(),this.select.style.display="none",this._out=l().openMidiOut(void 0,/MIDI Through/i),this._player&&this._player.connect(this._out),this._connector=void 0))},l.gui.Player=v}function t(){}function u(t){this.div=document.createElement("div"),this.div.style.display="inline-block",this.div.style.position="absolute",this.div.style.top="8px",this.div.style.margin="0",this.div.style.padding="2px",this.div.style.borderStyle="solid",this.div.style.borderWidth="1px",this.div.style.borderColor="#aaa",this.div.style.backgroundColor="#888",this.div.style.width="18px",this.div.style.height="18px",this.div.innerHTML=t}function f(t){t.stopPropagation(),t.preventDefault()}function v(t,e){if(!(this instanceof v))return new v(t,e);var i={at:void 0,x:void 0,y:void 0,play:!0,record:!1,pause:!0,stop:!0,loop:!0,open:!1,more:!0,close:!1};for(var o in i)i.hasOwnProperty(o)&&void 0!==t[o]&&(i[o]=t[o]);if(void 0===i.at&&(i.at=t),void 0===i.x&&(i.x=t),void 0===i.y&&(i.y=e),function(e,t){e.gui=document.createElement("div"),e.gui.style.display="inline-block",e.gui.style.position="relative",e.gui.style.margin="0px",e.gui.style.padding="0px",e.gui.style.borderStyle="none",e.gui.style.backgroundColor="#888",e.gui.style.width="270px",e.gui.style.height="40px";var i=8,o=238,s=28;t.play?(e.playBtn=new u(a),e.playBtn.div.style.left=i+"px",i+=s,e.playBtn.div.title="play",e.playBtn.div.addEventListener("click",function(){e.play()}),e.gui.appendChild(e.playBtn.div)):e.playBtn=n,t.pause?(e.pauseBtn=new u(p),e.pauseBtn.div.style.left=i+"px",i+=s,e.pauseBtn.div.title="pause",e.pauseBtn.div.addEventListener("click",function(){e.pause()}),e.gui.appendChild(e.pauseBtn.div)):e.pauseBtn=n,t.stop?(e.stopBtn=new u(r),e.stopBtn.div.style.left=i+"px",i+=s,e.stopBtn.div.title="stop",e.stopBtn.div.addEventListener("click",function(){e.stop()}),e.gui.appendChild(e.stopBtn.div)):e.stopBtn=n,t.loop?(e.loopBtn=new u(h),e.loopBtn.div.style.left=i+"px",i+=s,e.loopBtn.div.title="loop",e.loopBtn.div.addEventListener("click",function(){e.loop()}),e.gui.appendChild(e.loopBtn.div)):e.loopBtn=n,t.more?(e.moreBtn=new u(d),e.moreBtn.div.style.left=o+"px",o-=s,e.moreBtn.div.title="midi",e.moreBtn.div.addEventListener("click",function(){e.settings()}),e.gui.appendChild(e.moreBtn.div),e.select=document.createElement("select"),e.select.style.position="absolute",e.select.style.top="30px",e.select.style.left="40px",e.select.style.width="230px",e.select.style.display="none",e.select.style.zIndex=1,e.select.addEventListener("click",function(){e._selected()}),e.select.addEventListener("keydown",function(t){e._keydown(t)}),e.select.addEventListener("focusout",function(){e._closeselect()}),e.gui.appendChild(e.select)):e.moreBtn=n,t.open?(e.openBtn=new u(c),e.openBtn.div.style.left=o+"px",o-=s,e.openBtn.div.title="file",e.gui.appendChild(e.openBtn.div),e.fileInput=document.createElement("input"),e.fileInput.type="file",e.fileInput.style.position="fixed",e.fileInput.style.top="-1000px",e.fileInput.accept=".mid, .midi, .kar, .rmi",e.gui.appendChild(e.fileInput),window.FileReader&&(e.openBtn.off(),e.openBtn.div.addEventListener("click",function(){e.fileInput.click()}),e.fileInput.addEventListener("change",function(t){f(t),e.readFile(t.target.files[0])}),e.gui.addEventListener("drop",function(t){f(t),e.openBtn.off(),e.readFile(t.dataTransfer.files[0])}),e.gui.addEventListener("dragover",function(t){f(t),e.openBtn.on(),t.dataTransfer.dropEffect="copy"}),e.gui.addEventListener("dragexit",function(t){f(t),e.openBtn.off()}))):e.openBtn=n,t.close&&(e.closeBtn=document.createElement("div"),e.closeBtn.style.display="inline-block",e.closeBtn.style.position="absolute",e.closeBtn.style.top="1px",e.closeBtn.style.left="263px",e.closeBtn.style.margin="0",e.closeBtn.style.padding="0",e.closeBtn.style.backgroundColor="#ccc",e.closeBtn.style.width="6px",e.closeBtn.style.height="6px",e.closeBtn.title="close",e.closeBtn.addEventListener("click",function(){e.close()}),e.gui.appendChild(e.closeBtn)),e.rlen=o-i+10,e.rail=document.createElement("div"),e.rail.style.display="inline-block",e.rail.style.position="absolute",e.rail.style.top="19px",e.rail.style.left=i+5+"px",e.rail.style.width=e.rlen+"px",e.rail.style.height="0",e.rail.style.padding="1px",e.rail.style.borderStyle="solid",e.rail.style.borderWidth="1px",e.rail.style.borderRadius="2px",e.rail.style.borderColor="#aaa",e.rail.style.backgroundColor="#888",e.gui.appendChild(e.rail),e.caret=document.createElement("div"),e.caret.style.display="inline-block",e.caret.style.position="absolute",e.caret.style.width="2px",e.caret.style.height="2px",e.caret.style.top="-5px",e.caret.style.left="-5px",e.caret.style.padding="4px",e.caret.style.borderStyle="solid",e.caret.style.borderWidth="1px",e.caret.style.borderRadius="6px",e.caret.style.borderColor="#aaa",e.caret.style.backgroundColor="#888",e.caret.addEventListener("mousedown",function(t){e._mousedown(t)}),e.rail.appendChild(e.caret),window.addEventListener("mousemove",function(t){e._mousemove(t)}),window.addEventListener("mouseup",function(t){e._mouseup(t)})}(this,i),"string"==typeof i.at)try{return document.getElementById(i.at).appendChild(this.gui),this}catch(t){}try{return i.at.appendChild(this.gui),this}catch(t){}i.x==parseInt(i.x)&&i.y==parseInt(i.y)||(i.x=45*y+5,i.y=15*y+5,y++),this.gui.style.position="fixed",this.gui.style.top=i.x+"px",this.gui.style.left=i.y+"px",this.gui.style.opacity=.9;var s=this;this.gui.addEventListener("mousedown",function(t){s._startmove(t)}),document.body.appendChild(this.gui)}function e(t){return void 0===t.buttons?!t.button:1&t.buttons}});