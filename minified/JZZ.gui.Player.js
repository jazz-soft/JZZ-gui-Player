!function(t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t:"function"==typeof define&&define.amd?define("JZZ.gui.Player",["JZZ","JZZ.midi.SMF"],t):t(JZZ)}(function(p){var r,h,d,c,u,y,f,_,v,g;function e(){}function m(t){this.div=document.createElement("div"),this.div.style.display="inline-block",this.div.style.position="absolute",this.div.style.boxSizing="content-box",this.div.style.top="8px",this.div.style.margin="0",this.div.style.padding="2px",this.div.style.borderStyle="solid",this.div.style.borderWidth="1px",this.div.style.borderColor="#aaa",this.div.style.backgroundColor="#888",this.div.style.lineHeight="0",this.div.style.lineSpasing="0",this.div.style.width="18px",this.div.style.height="18px",this.div.innerHTML=t}function B(t){t.stopPropagation(),t.preventDefault()}function w(t,i){if(!(this instanceof w))return new w(t,i);var e,o,s,n,l={at:void 0,x:void 0,y:void 0,play:!0,record:!1,pause:!0,stop:!0,loop:!0,file:!1,link:!1,midi:!0,close:!1,sndoff:!0,ports:[void 0,/MIDI Through/i],connect:!0};if("object"==typeof t)for(var p in l)l.hasOwnProperty(p)&&void 0!==t[p]&&(l[p]=t[p]);if(void 0===l.at&&(l.at=t),void 0===l.x&&(l.x=t),void 0===l.y&&(l.y=i),i=l,(e=this).gui=document.createElement("div"),e.gui.style.display="inline-block",e.gui.style.position="relative",e.gui.style.boxSizing="content-box",e.gui.style.margin="0px",e.gui.style.padding="0px",e.gui.style.borderStyle="none",e.gui.style.backgroundColor="#888",e.gui.style.width="270px",e.gui.style.height="40px",o=8,s=238,n=28,i.play?(e.playBtn=new m(h),e.playBtn.div.style.left=o+"px",o+=n,e.playBtn.div.title="play",e.playBtn.div.addEventListener("click",function(){e.play()}),e.gui.appendChild(e.playBtn.div)):e.playBtn=r,i.pause?(e.pauseBtn=new m(d),e.pauseBtn.div.style.left=o+"px",o+=n,e.pauseBtn.div.title="pause",e.pauseBtn.div.addEventListener("click",function(){e.pause()}),e.gui.appendChild(e.pauseBtn.div)):e.pauseBtn=r,i.stop?(e.stopBtn=new m(c),e.stopBtn.div.style.left=o+"px",o+=n,e.stopBtn.div.title="stop",e.stopBtn.div.addEventListener("click",function(){e.stop()}),e.gui.appendChild(e.stopBtn.div)):e.stopBtn=r,i.loop?(e.loopBtn=new m(u),e.loopBtn.div.style.left=o+"px",o+=n,e.loopBtn.div.title="loop",e.loopBtn.div.addEventListener("click",function(){e.loop()}),e.gui.appendChild(e.loopBtn.div)):e.loopBtn=r,i.midi?(e.midiBtn=new m(y),e.midiBtn.div.style.left=s+"px",s-=n,e.midiBtn.div.title="midi",e.midiBtn.div.addEventListener("click",function(){e.settings()}),e.gui.appendChild(e.midiBtn.div),e.sel=document.createElement("select"),e.sel.style.position="absolute",e.sel.style.top="30px",e.sel.style.left="40px",e.sel.style.width="230px",e.sel.style.display="none",e.sel.style.zIndex=1,e.sel.addEventListener("click",function(){e._selected()}),e.sel.addEventListener("keydown",function(t){e._keydown(t)}),e.sel.addEventListener("focusout",function(){e._closeselect()}),e.gui.appendChild(e.sel)):e.midiBtn=r,i.link&&(e.linkBtn=new m(_),e.linkBtn.div.style.left=s+"px",s-=n,e.linkBtn.div.title="link",e.gui.appendChild(e.linkBtn.div)),i.file?(e.fileBtn=new m(f),e.fileBtn.div.style.left=s+"px",s-=n,e.fileBtn.div.title="file",e.gui.appendChild(e.fileBtn.div),e.fileInput=document.createElement("input"),e.fileInput.type="file",e.fileInput.style.position="fixed",e.fileInput.style.top="-1000px",e.fileInput.accept=".mid, .midi, .kar, .rmi, .syx",e.gui.appendChild(e.fileInput),window.FileReader&&(e.fileBtn.off(),e.fileBtn.div.addEventListener("click",function(){e.fileInput.click()}),e.fileInput.addEventListener("change",function(t){B(t),t.target.files[0]&&e.readFile(t.target.files[0])}),e.gui.addEventListener("drop",function(t){B(t),e.fileBtn.off(),e.readFile(t.dataTransfer.files[0])}),e.gui.addEventListener("dragover",function(t){B(t),e.fileBtn.on(),t.dataTransfer.dropEffect="copy"}),e.gui.addEventListener("dragexit",function(t){B(t),e.fileBtn.off()}))):e.fileBtn=r,i.close&&(e.closeBtn=document.createElement("div"),e.closeBtn.style.display="inline-block",e.closeBtn.style.position="absolute",e.closeBtn.style.boxSizing="content-box",e.closeBtn.style.top="1px",e.closeBtn.style.left="262px",e.closeBtn.style.margin="0",e.closeBtn.style.padding="0",e.closeBtn.style.backgroundColor="#f44",e.closeBtn.style.width="7px",e.closeBtn.style.height="7px",e.closeBtn.style.lineHeight="0",e.closeBtn.style.lineSpasing="0",e.closeBtn.innerHTML=v,e.closeBtn.title="close",e.closeBtn.addEventListener("click",function(){e.destroy()}),e.gui.appendChild(e.closeBtn)),e.rlen=s-o+10,e.lbl=document.createElement("div"),e.lbl.style.display="inline-block",e.lbl.style.position="absolute",e.lbl.style.top="26px",e.lbl.style.left=o+"px",e.lbl.style.width=e.rlen+10+"px",e.lbl.style.height="12px",e.lbl.style.padding="0",e.lbl.style.textAlign="center",e.lbl.style.color="#aaa",e.lbl.style.fontSize="12px",e.lbl.style.fontFamily="Arial, Helvetica, sans-serif",e.gui.appendChild(e.lbl),e.rail=document.createElement("div"),e.rail.style.display="inline-block",e.rail.style.position="absolute",e.rail.style.boxSizing="content-box",e.rail.style.top="19px",e.rail.style.left=o+5+"px",e.rail.style.width=e.rlen+"px",e.rail.style.height="0",e.rail.style.padding="1px",e.rail.style.borderStyle="solid",e.rail.style.borderWidth="1px",e.rail.style.borderRadius="2px",e.rail.style.borderColor="#aaa",e.rail.style.backgroundColor="#888",e.gui.appendChild(e.rail),e.caret=document.createElement("div"),e.caret.style.display="inline-block",e.caret.style.position="absolute",e.caret.style.boxSizing="content-box",e.caret.style.width="2px",e.caret.style.height="2px",e.caret.style.top="-5px",e.caret.style.left="-5px",e.caret.style.padding="4px",e.caret.style.borderStyle="solid",e.caret.style.borderWidth="1px",e.caret.style.borderRadius="6px",e.caret.style.borderColor="#aaa",e.caret.style.backgroundColor="#888",e.caret.addEventListener("mousedown",function(t){e._mousedown(t)}),e.rail.appendChild(e.caret),window.addEventListener("mousemove",function(t){e._mousemove(t)}),window.addEventListener("mouseup",function(t){e._mouseup(t)}),l.ports instanceof Array||(l.ports=[l.ports]),l.ports.push(void 0),this._ports=l.ports,this._conn=l.connect,this._sndoff=l.sndoff,this.disable(),"string"==typeof l.at)try{return document.getElementById(l.at).appendChild(this.gui),this}catch(t){}try{return l.at.appendChild(this.gui),this}catch(t){}l.x==parseInt(l.x)&&l.y==parseInt(l.y)||(l.x=15*g+5,l.y=45*g+5,g++),this.gui.style.position="fixed",this.gui.style.top=l.y+"px",this.gui.style.left=l.x+"px",this.gui.style.opacity=.9;var a=this;this.gui.addEventListener("mousedown",function(t){a._startmove(t)}),document.body.appendChild(this.gui)}function i(t){return void 0===t.buttons?!t.button:1&t.buttons}p.gui||(p.gui={}),p.gui.Player||(r={on:e,off:e,disable:e,title:e,div:{}},m.prototype.on=function(){this.div.style.backgroundColor="#ddd",this.div.style.borderColor="#ccc",this.div.firstChild.style.fill="#000"},m.prototype.off=function(){this.div.style.backgroundColor="#aaa",this.div.style.borderColor="#ccc",this.div.firstChild.style.fill="#000"},m.prototype.disable=function(){this.div.style.backgroundColor="#888",this.div.style.borderColor="#aaa",this.div.firstChild.style.fill="#555"},m.prototype.title=function(t){this.div.title=t},h='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',d='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',c='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 6h12v12H6z"/></svg>',u='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>',y='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>',f='<svg fill="#555" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M10 4H2v16h20V6H12l-2-2z"/></svg>',_='<svg fill="#555" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/><path fill="none" d="M0 0h24v24H0z"/></svg>',v='<svg stroke="#ff8" xmlns="http://www.w3.org/2000/svg" width="7" height="7" viewBox="0 0 7 7"><line x1="1" y1="1" x2="6" y2="6"/><line x1="1" y1="6" x2="6" y2="1"/></svg>',g=0,((w.prototype=new p.Widget).constructor=w).prototype.label=function(t){this.lbl.innerHTML=t},w.prototype.disable=function(){this.playBtn.disable(),this.pauseBtn.disable(),this.stopBtn.disable(),this.loopBtn.disable(),this.midiBtn.disable(),this._conn&&this.midiBtn.off(),this.fileBtn.off(),this.rail.style.borderColor="#aaa",this.rail.style.backgroundColor="#888",this.caret.style.borderColor="#aaa",this.caret.style.backgroundColor="#888"},w.prototype.enable=function(){this.playBtn.off(),this.pauseBtn.off(),this.stopBtn.off(),this.loopBtn.off(),this._conn&&this.midiBtn.off(),this.rail.style.borderColor="#ccc",this.caret.style.backgroundColor="#aaa",this.caret.style.borderColor="#ccc"},w.prototype.load=function(t){var i=this;this._player=t.player(),this._player.trim(),this._player.connect(this),this._player.onEnd=function(){i._onEnd()},this._player.filter(this._setfilter),this._sndoff||(this._player.sndOff=e),this.enable(),this.onLoad(t)},w.prototype.filter=function(t){this._setfilter=t instanceof Function?t:void 0,this._player&&this._player.filter(this._setfilter)},w.prototype.onSelect=e,w.prototype.onEnd=e,w.prototype.onLoad=e,w.prototype._onEnd=function(){this.onEnd(),this._loop&&-1!=this._loop&&this._loop--,this._loop?1==this._loop?(this._loop=0,this.loopBtn.off(),this.loopBtn.title("loop")):this.loopBtn.title("loop: "+(-1==this._loop?"∞":this._loop)):(this._moving&&clearInterval(this._moving),this._move(),this._playing=!1,this.playBtn.off())},w.prototype._move=function(){var t=Math.round(this._player.positionMS()*this.rlen/this._player.durationMS())-5;this.caret.style.left=t+"px"},w.prototype.onPlay=e,w.prototype.onResume=e,w.prototype._resume=function(){var t=this;this._player.resume(),this._moving=setInterval(function(){t._move()},100)},w.prototype.play=function(){var t;this._player&&((t=this).playBtn.on(),this.pauseBtn.off(),this._playing||(this._paused?this.onResume():this.onPlay(),this._playing=!0,this._paused=!1,this._out||!this._conn?this._resume():this._waiting||(this._waiting=!0,p().openMidiOut(t._ports).and(function(){t._out=this,t._outname=this.name(),t.midiBtn.title(t._outname),t._connect(this),t._waiting=!1,t.onSelect(t._outname),t._playing&&t._resume()}).or(function(){t._waiting=!1,t._resume()}))))},w.prototype.onStop=e,w.prototype.stop=function(){var t;this._player&&((t=this)._player.stop(),p.lib.schedule(function(){t.onStop()}),this._moving&&clearInterval(this._moving),this._playing=!1,this._paused=!1,this.playBtn.off(),this.pauseBtn.off(),this._move())},w.prototype.onPause=e,w.prototype.pause=function(t){var i;this._player&&((i=this)._paused?void 0!==t&&!t||(this._out?(this._resume(),this.onResume(),this._playing=!0,this._paused=!1,this.playBtn.on(),this.pauseBtn.off()):this.play()):!this._playing||void 0!==t&&t||(this._player.pause(),p.lib.schedule(function(){i.onPause()}),this._moving&&clearInterval(this._moving),this._playing=!1,this._paused=!0,this.playBtn.off(),this.pauseBtn.on()))},w.prototype.loop=function(t){this._player&&((t=void 0===t?!this._loop:t)==parseInt(t)&&0<t?this._loop=t:this._loop=t?-1:0,1==this._loop&&(this._loop=0),this._player.loop(this._loop),this._loop?(this.loopBtn.on(),this.loopBtn.title("loop: "+(-1==this._loop?"∞":this._loop))):(this.loopBtn.off(),this.loopBtn.title("loop")))},w.prototype.onClose=e,w.prototype.destroy=function(){var t;this.stop(),this._out&&(t=this._out,p.lib.schedule(function(){t.close()})),this.gui.parentNode.removeChild(this.gui),this.onClose()},w.prototype.setUrl=function(t,i){this.linkBtn&&(this._url&&(this.linkBtn.div.appendChild(this._url.firstChild),this.linkBtn.div.removeChild(this._url),this._url=void 0),void 0===t?this.linkBtn.disable():(this.linkBtn.off(),this._url=document.createElement("a"),this._url.target="_blank",this._url.appendChild(this.linkBtn.div.firstChild),this.linkBtn.div.appendChild(this._url),this._url.href=t,this._url.dataset||(this._url.dataset={}),this._url.dataset.jzzGuiPlayer=!0,void 0!==i&&(this._url.download=i)))},w.prototype.readFile=function(n){var l=this,t=new FileReader;t.onload=function(t){for(var i,e="",o=new Uint8Array(t.target.result),s=0;s<o.length;s++)e+=String.fromCharCode(o[s]);try{i=new p.MIDI.SYX(e)}catch(t){}try{i=i||new p.MIDI.SMF(e),l.stop(),p.lib.schedule(function(){l.load(i)}),l.linkBtn&&l.setUrl("data:audio/midi;base64,"+p.lib.toBase64(e),n.name)}catch(t){console.log(t.message)}},t.readAsArrayBuffer(n)},w.prototype.onSelect=e,w.prototype._closeselect=function(){this.midiBtn.off(),this.sel.style.display="none",this._more=!1},w.prototype.settings=function(){var e;!this._more&&this._conn&&((e=this)._more=!0,this.midiBtn.on(),this.sel.style.display="inline-block",p().refresh().and(function(){for(var t=this.info().outputs,i=0;i<e.sel.options.length;i++)e.sel.remove(i);for(i=0;i<t.length;i++)e.sel[i]=new Option(t[i].name,t[i].name,t[i].name==e._outname,t[i].name==e._outname);e.sel.size=t.length<2?2:t.length,e.sel.focus()}))},w.prototype._selectMidi=function(){var i=this;p().openMidiOut(this._newname).or(function(){i._newname=void 0,i._closeselect()}).and(function(){if(i._newname=void 0,i._outname!=this.name()){if(i._outname=this.name(),i._closeselect(),i._out){if(i._playing)for(var t=0;t<16;t++)i._out._receive(p.MIDI.allSoundOff(t));i._disconnect(i._out),i._out.close()}i._out=this,i._connect(this),i.midiBtn.title(i._outname),i.onSelect(i._outname),setTimeout(function(){i.onSelect(i._outname)},0)}})},w.prototype.select=function(t){var i=this;this._newname=t||0,this._newname==this._outname?(this._newname=void 0,this._closeselect()):setTimeout(function(){i._selectMidi()},0)},w.prototype._selected=function(){var t=this.sel.options[this.sel.selectedIndex];t&&this.select(t.value)},w.prototype._keydown=function(t){13!=t.keyCode&&32!=t.keyCode||this._selected()},w.prototype.type=function(){return this._player?this._player.type():0},w.prototype.tracks=function(){return this._player?this._player.tracks():0},w.prototype.duration=function(){return this._player?this._player.duration():0},w.prototype.durationMS=function(){return this._player?this._player.durationMS():0},w.prototype.position=function(){return this._player?this._player.position():0},w.prototype.positionMS=function(){return this._player?this._player.positionMS():0},w.prototype.tick2ms=function(){return this._player?this._player.tick2ms():0},w.prototype.ms2tick=function(){return this._player?this._player.ms2tick():0},w.prototype.onJump=e,w.prototype.jump=function(t){this._player&&(this._player.jump(t),this._move(),this._playing||(t?(this._paused=!0,this.playBtn.off(),this.pauseBtn.on()):(this._paused=!1,this.playBtn.off(),this.pauseBtn.off())),this.onJump(this._player.position()))},w.prototype.jumpMS=function(t){this._player&&(this._player.jumpMS(t),this._move(),this._playing||(t?(this._paused=!0,this.playBtn.off(),this.pauseBtn.on()):(this._paused=!1,this.playBtn.off(),this.pauseBtn.off())),this.onJump(this._player.position()))},w.prototype.speed=function(t){return this._player?this._player.speed(t):1},w.prototype._mousedown=function(t){i(t)&&this._player&&(this._more||t.preventDefault(),this.caret.style.backgroundColor="#ddd",this._wasPlaying=this._playing,this._player.pause(),this._caretX=t.clientX,this._caretPos=parseInt(this.caret.style.left)+5)},w.prototype._startmove=function(t){i(t)&&(this._more||t.preventDefault(),this._startX=parseInt(this.gui.style.left),this._startY=parseInt(this.gui.style.top),this._clickX=t.clientX,this._clickY=t.clientY)},w.prototype._mouseup=function(){this._player&&void 0!==this._caretX&&(this._wasPlaying&&(this._wasPlaying=void 0,this._player.resume()),this.caret.style.backgroundColor="#aaa",this._caretX=void 0),void 0!==this._startX&&(this._startX=void 0,this._startY=void 0,this._clickX=void 0,this._clickY=void 0)},w.prototype._mousemove=function(t){var i;this._more&&(this._startX=void 0,this._startY=void 0,this._clickX=void 0,this._clickY=void 0),this._player&&void 0!==this._caretX?(t.preventDefault(),(i=(i=this._caretPos+t.clientX-this._caretX)<0?0:i)>this.rlen&&(i=this.rlen),this.jumpMS(this.durationMS()*i*1/this.rlen)):void 0!==this._startX&&(t.preventDefault(),this.gui.style.left=this._startX-this._clickX+t.clientX+"px",this.gui.style.top=this._startY-this._clickY+t.clientY+"px")},w.prototype._connect=w.prototype.connect,w.prototype._disconnect=w.prototype.disconnect,w.prototype.connect=function(t){t==this?(this._conn=!0,this.midiBtn.off()):this._connect(t)},w.prototype.disconnect=function(t){t==this?(this._conn=!1,this._out&&this._disconnect(this._out),this._outname=void 0,this.midiBtn.disable()):this._disconnect(t)},w.prototype.connected=function(){return this._outname},p.gui.Player=w)});