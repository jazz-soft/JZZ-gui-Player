!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i:"function"==typeof define&&define.amd?define("JZZ.gui.Player",["JZZ","JZZ.midi.SMF"],i):i(JZZ)}(0,function(i){if(i.gui||(i.gui={}),!i.gui.Player){var n={on:t,off:t,disable:t,div:{}};y.prototype.on=function(){this.div.style.backgroundColor="#ddd",this.div.style.borderColor="#ccc",this.div.firstChild.style.fill="#000"},y.prototype.off=function(){this.div.style.backgroundColor="#aaa",this.div.style.borderColor="#ccc",this.div.firstChild.style.fill="#000"},y.prototype.disable=function(){this.div.style.backgroundColor="#888",this.div.style.borderColor="#aaa",this.div.firstChild.style.fill="#555"};var l='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',p='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/><path d="M0 0h24v24H0z" fill="none"/></svg>',a='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 6h12v12H6z"/></svg>',h='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>',r='<svg fill="#555" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>',d='<svg fill="#555" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M10 4H2v16h20V6H12l-2-2z"/></svg>',c=0;u.prototype.disable=function(){this.playBtn.disable(),this.pauseBtn.disable(),this.stopBtn.disable(),this.loopBtn.disable(),this.moreBtn.disable(),this.openBtn.off(),this.rail.style.borderColor="#aaa",this.rail.style.backgroundColor="#888",this.caret.style.borderColor="#aaa",this.caret.style.backgroundColor="#888"},u.prototype.enable=function(){this.playBtn.off(),this.pauseBtn.off(),this.stopBtn.off(),this.loopBtn.off(),this._out||this.moreBtn.off(),this.rail.style.borderColor="#ccc",this.caret.style.backgroundColor="#aaa",this.caret.style.borderColor="#ccc"},u.prototype.load=function(t){var i=this;this._player=t.player(),this._out&&this._player.connect(this._out),this._player.onEnd=function(){i._onEnd()},this.enable()},u.prototype.onEnd=function(){},u.prototype._onEnd=function(){this.onEnd(),this._loop&&-1!=this._loop&&this._loop--,this._loop?1==this._loop?(this._loop=0,this.loopBtn.off(),this.loopBtn.div.title="loop"):this.loopBtn.div.title="loop: "+(-1==this._loop?"∞":this._loop):(this._moving&&clearInterval(this._moving),this._move(),this._playing=!1,this.playBtn.off())},u.prototype._move=function(){var t=Math.round(this._player.position()*this.rlen/this._player.duration())-5;this.caret.style.left=t+"px"},u.prototype.play=function(){if(this._player){var t=this;if(this.playBtn.on(),this.pauseBtn.off(),this._out){if(this._playing)return;this._waiting=!1,this._player.connect(this._out),this._paused?this._player.resume():this._player.play(),this._moving=setInterval(function(){t._move()},100),this._playing=!0,this._paused=!1}else this._waiting||(this._waiting=!0,i().openMidiOut(void 0,/MIDI Through/i).and(function(){t._out=this,t._outname=this.name(),t.play()}))}},u.prototype.stop=function(){this._player&&(this._player.stop(),this._moving&&clearInterval(this._moving),this._playing=!1,this._paused=!1,this.playBtn.off(),this.pauseBtn.off(),this._move())},u.prototype.pause=function(t){if(this._player){var i=this;this._paused?(void 0===t||t)&&(this._out?(this._player.resume(),this._moving=setInterval(function(){i._move()},100),this._playing=!0,this._paused=!1,this.playBtn.on(),this.pauseBtn.off()):this.play()):this._playing&&(void 0!==t&&t||(this._player.pause(),this._moving&&clearInterval(this._moving),this._playing=!1,this._paused=!0,this.playBtn.off(),this.pauseBtn.on()))}},u.prototype.loop=function(t){this._player&&(void 0===t&&(t=!this._loop),t==parseInt(t)&&0<t?this._loop=t:this._loop=t?-1:0,1==this._loop&&(this._loop=0),this._player.loop(this._loop),this._loop?(this.loopBtn.on(),this.loopBtn.div.title="loop: "+(-1==this._loop?"∞":this._loop)):(this.loopBtn.off(),this.loopBtn.div.title="loop"))},u.prototype._closeselect=function(){this.moreBtn.off(),this.select.style.display="none",this._more=!1},u.prototype.settings=function(){if(this._player&&!this._more&&!this._connector){var e=this;this._more=!0,this.moreBtn.on(),this.select.style.display="inline-block",i().refresh().and(function(){var t,i=this.info().outputs;for(t=0;t<e.select.options.length;t++)e.select.remove(t);for(t=0;t<i.length;t++)e.select[t]=new Option(i[t].name,i[t].name,i[t].name==e._outname,i[t].name==e._outname);e.select.size=i.length<2?2:i.length,e.select.focus()})}},u.prototype._selectMidi=function(){var t=this;i().openMidiOut(this._newname).or(function(){t._newname=void 0,t._closeselect()}).and(function(){t._connector||(t._outname=t._newname,t._player&&(t._player.sndOff(),t._player.disconnect(t._out)),t._out=this,t._player&&t._player.connect(t._out),t._newname=void 0,t._closeselect())})},u.prototype._selected=function(){var t=this;this._newname=this.select.options[this.select.selectedIndex].value,this._newname==this._outname?(this._newname=void 0,t._closeselect()):setTimeout(function(){t._selectMidi()},0)},u.prototype._keydown=function(t){13!=t.keyCode&&32!=t.keyCode||this._selected()},u.prototype.duration=function(){return this._player?this._player.duration():0},u.prototype.position=function(){return this._player?this._player.position():0},u.prototype.jump=function(t){this._player&&(this._player.jump(t),this._move(),this._playing||(t?(this._paused=!0,this.playBtn.off(),this.pauseBtn.on()):(this._paused=!1,this.playBtn.off(),this.pauseBtn.off())))},u.prototype._mousedown=function(t){e(t)&&this._player&&(this.caret.style.backgroundColor="#ddd",this._wasPlaying=this._playing,this._player.pause(),this._caretX=t.clientX,this._caretPos=parseInt(this.caret.style.left)+5)},u.prototype._startmove=function(t){e(t)&&(this._startX=parseInt(this.gui.style.left),this._startY=parseInt(this.gui.style.top),this._clickX=t.clientX,this._clickY=t.clientY)},u.prototype._mouseup=function(t){this._player&&void 0!==this._caretX&&(this._wasPlaying&&(this._wasPlaying=void 0,this._player.resume()),this.caret.style.backgroundColor="#aaa",this._caretX=void 0),void 0!==this._startX&&(this._startX=void 0,this._startY=void 0,this._clickX=void 0,this._clickY=void 0)},u.prototype._mousemove=function(t){if(this._player&&void 0!==this._caretX){t.preventDefault();var i=this._caretPos+t.clientX-this._caretX;i<0&&(i=0),i>this.rlen&&(i=this.rlen),this.jump(this.duration()*i*1/this.rlen)}else void 0!==this._startX&&(t.preventDefault(),this.gui.style.left=this._startX-this._clickX+t.clientX+"px",this.gui.style.top=this._startY-this._clickY+t.clientY+"px")},u.prototype.connect=function(t){this._connector||(this._connector=new i.Widget,this._player&&(this._playing&&this._player.sndOff(),this._player.disconnect(),this._player.connect(this._connector)),this.moreBtn.disable(),this._out=this._connector),this._connector.connect(t)},u.prototype.disconnect=function(t){this._connector&&(this._player&&this._playing&&this._player.sndOff(),this._connector.disconnect(t),this._connector.connected()||(this.moreBtn.off(),this.select.style.display="none",this._out=i().openMidiOut(void 0,/MIDI Through/i),this._player&&this._player.connect(this._out),this._connector=void 0))},i.gui.Player=u}function t(){}function y(t){this.div=document.createElement("div"),this.div.style.display="inline-block",this.div.style.position="absolute",this.div.style.top="8px",this.div.style.margin="0",this.div.style.padding="2px",this.div.style.borderStyle="solid",this.div.style.borderWidth="1px",this.div.style.borderColor="#aaa",this.div.style.backgroundColor="#888",this.div.style.width="18px",this.div.style.height="18px",this.div.innerHTML=t}function u(t,i){if(!(this instanceof u))return new u(t,i);var e={at:void 0,x:void 0,y:void 0,play:!0,record:!1,pause:!0,stop:!0,loop:!0,open:!1,more:!0,close:!1};for(var o in e)e.hasOwnProperty(o)&&void 0!==t[o]&&(e[o]=t[o]);if(void 0===e.at&&(e.at=t),void 0===e.x&&(e.x=t),void 0===e.y&&(e.y=i),function(i,t){i.gui=document.createElement("div"),i.gui.style.display="inline-block",i.gui.style.position="relative",i.gui.style.margin="0px",i.gui.style.padding="0px",i.gui.style.borderStyle="none",i.gui.style.backgroundColor="#888",i.gui.style.width="270px",i.gui.style.height="40px";var e=8,o=238,s=28;t.play?(i.playBtn=new y(l),i.playBtn.div.style.left=e+"px",e+=s,i.playBtn.div.title="play",i.playBtn.div.addEventListener("click",function(){i.play()}),i.gui.appendChild(i.playBtn.div)):i.playBtn=n,t.pause?(i.pauseBtn=new y(p),i.pauseBtn.div.style.left=e+"px",e+=s,i.pauseBtn.div.title="pause",i.pauseBtn.div.addEventListener("click",function(){i.pause()}),i.gui.appendChild(i.pauseBtn.div)):i.pauseBtn=n,t.stop?(i.stopBtn=new y(a),i.stopBtn.div.style.left=e+"px",e+=s,i.stopBtn.div.title="stop",i.stopBtn.div.addEventListener("click",function(){i.stop()}),i.gui.appendChild(i.stopBtn.div)):i.stopBtn=n,t.loop?(i.loopBtn=new y(h),i.loopBtn.div.style.left=e+"px",e+=s,i.loopBtn.div.title="loop",i.loopBtn.div.addEventListener("click",function(){i.loop()}),i.gui.appendChild(i.loopBtn.div)):i.loopBtn=n,t.more?(i.moreBtn=new y(r),i.moreBtn.div.style.left=o+"px",o-=s,i.moreBtn.div.title="midi",i.moreBtn.div.addEventListener("click",function(){i.settings()}),i.gui.appendChild(i.moreBtn.div),i.select=document.createElement("select"),i.select.style.position="absolute",i.select.style.top="30px",i.select.style.left="40px",i.select.style.width="230px",i.select.style.display="none",i.select.style.zIndex=1,i.select.addEventListener("click",function(){i._selected()}),i.select.addEventListener("keydown",function(t){i._keydown(t)}),i.select.addEventListener("focusout",function(){i._closeselect()}),i.gui.appendChild(i.select)):i.moreBtn=n,t.open?(i.openBtn=new y(d),i.openBtn.div.style.left=o+"px",o-=s,i.openBtn.div.title="file",i.gui.appendChild(i.openBtn.div),i.openBtn.off(),i.fileInput=document.createElement("input"),i.fileInput.type="file",i.fileInput.style.display="none",i.fileInput.accept=".mid, .midi, .kar, .rmi",i.gui.appendChild(i.fileInput),i.openBtn.div.addEventListener("click",function(){i.fileInput.click()})):i.openBtn=n,i.rlen=o-e+10,i.rail=document.createElement("div"),i.rail.style.display="inline-block",i.rail.style.position="absolute",i.rail.style.top="19px",i.rail.style.left=e+5+"px",i.rail.style.width=i.rlen+"px",i.rail.style.height="0",i.rail.style.padding="1px",i.rail.style.borderStyle="solid",i.rail.style.borderWidth="1px",i.rail.style.borderRadius="2px",i.rail.style.borderColor="#aaa",i.rail.style.backgroundColor="#888",i.gui.appendChild(i.rail),i.caret=document.createElement("div"),i.caret.style.display="inline-block",i.caret.style.position="absolute",i.caret.style.width="2px",i.caret.style.height="2px",i.caret.style.top="-5px",i.caret.style.left="-5px",i.caret.style.padding="4px",i.caret.style.borderStyle="solid",i.caret.style.borderWidth="1px",i.caret.style.borderRadius="6px",i.caret.style.borderColor="#aaa",i.caret.style.backgroundColor="#888",i.caret.addEventListener("mousedown",function(t){i._mousedown(t)}),i.rail.appendChild(i.caret),window.addEventListener("mousemove",function(t){i._mousemove(t)}),window.addEventListener("mouseup",function(t){i._mouseup(t)})}(this,e),"string"==typeof e.at)try{return document.getElementById(e.at).appendChild(this.gui),this}catch(t){}try{return e.at.appendChild(this.gui),this}catch(t){}e.x==parseInt(e.x)&&e.y==parseInt(e.y)||(e.x=45*c+5,e.y=15*c+5,c++),this.gui.style.position="fixed",this.gui.style.top=e.x+"px",this.gui.style.left=e.y+"px",this.gui.style.opacity=.9;var s=this;this.gui.addEventListener("mousedown",function(t){s._startmove(t)}),document.body.appendChild(this.gui)}function e(t){return void 0===t.buttons?!t.button:1&t.buttons}});